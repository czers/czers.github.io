<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Azure on czers.pl</title>
    <link>http://czers.pl/tags/azure/index.xml</link>
    <description>Recent content in Azure on czers.pl</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-US</language>
    <atom:link href="http://czers.pl/tags/azure/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>How to configure Azure firewall using CLI</title>
      <link>http://czers.pl/post/azure-firewall-cli-configuration/</link>
      <pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate>
      
      <guid>http://czers.pl/post/azure-firewall-cli-configuration/</guid>
      <description>&lt;p&gt;I&amp;rsquo;ve ran into some problems recently while trying to setup multiple instances
of &lt;a href=&#34;https://github.com/jlund/streisand&#34;&gt;Streisand VPN&lt;/a&gt;. It seems that on Microsoft Azure there&amp;rsquo;s no easy
way to copy or export/import firewall (Network Security Group - NSG)
configuration between different virtual machines using Azure Portal.&lt;/p&gt;

&lt;p&gt;Fortunately, Azure has &lt;a href=&#34;https://docs.microsoft.com/en-us/cli/azure/overview&#34;&gt;a CLI&lt;/a&gt; (version 2.0 now) available which
can be used to setup network security groups in an automated fashion.&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h1 id=&#34;choosing-subscription-to-use-with-cli&#34;&gt;Choosing subscription to use with CLI&lt;/h1&gt;

&lt;p&gt;If you use Azure, chances are you have multiple subscriptions associated with
your account. With Azure CLI, you have to choose upfront which subscription will
be used for subsequent commands. To list subscriptions available in your account
use:&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;$ az account list --output table
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This will produce output like this:&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;$ az account list --output table
Name                                  CloudName    SubscriptionId                        State    IsDefault
------------------------------------  -----------  ------------------------------------  -------  -----------
Visual Studio Professional with MSDN  AzureCloud   XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX  Enabled  True
Visual Studio Enterprise with MSDN    AzureCloud   XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX  Enabled
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA       AzureCloud   XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX  Enabled
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;To choose default subscription run:&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;$ az account &lt;span style=&#34;color: #f8f8f2&#34;&gt;set&lt;/span&gt; --subscription &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;Visual Studio Enterprise with MSDN&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This won&amp;rsquo;t produce any output, rerun &lt;code&gt;az account list --output table&lt;/code&gt; and look
at &lt;code&gt;IsDefault&lt;/code&gt; column if you want to make sure subscription context has been
changed successfully.&lt;/p&gt;

&lt;h1 id=&#34;setting-up-network-security-group-rules&#34;&gt;Setting up Network Security Group rules&lt;/h1&gt;

&lt;p&gt;The following script sets up all the rules needed by the current (April 2017)
version of Streisand VPN. Assign VM&amp;rsquo;s resource group name to &lt;code&gt;RG_NAME&lt;/code&gt; and its security group name to &lt;code&gt;NSG_NAME&lt;/code&gt;.&lt;/p&gt;

&lt;table class=&#34;highlighttable&#34;&gt;&lt;tr&gt;&lt;td&gt;&lt;div class=&#34;linenodiv&#34; style=&#34;background-color: #f0f0f0; padding-right: 10px&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #75715e&#34;&gt;#!/bin/sh&lt;/span&gt;

&lt;span style=&#34;color: #f8f8f2&#34;&gt;RG_NAME&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;phalanx-rg
&lt;span style=&#34;color: #f8f8f2&#34;&gt;NSG_NAME&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;phalanx-nsg

&lt;span style=&#34;color: #75715e&#34;&gt;# HTTPS (Streisand Gateway)&lt;/span&gt;
az network nsg rule create --resource-group &lt;span style=&#34;color: #f8f8f2&#34;&gt;$RG_NAME&lt;/span&gt; --nsg-name &lt;span style=&#34;color: #f8f8f2&#34;&gt;$NSG_NAME&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--name allow-https &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--priority &lt;span style=&#34;color: #ae81ff&#34;&gt;1010&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--destination-port-range &lt;span style=&#34;color: #ae81ff&#34;&gt;443&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--protocol Tcp

&lt;span style=&#34;color: #75715e&#34;&gt;# L2TP-IPSEC&lt;/span&gt;
az network nsg rule create --resource-group &lt;span style=&#34;color: #f8f8f2&#34;&gt;$RG_NAME&lt;/span&gt; --nsg-name &lt;span style=&#34;color: #f8f8f2&#34;&gt;$NSG_NAME&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--name allow-l2tp-ipsec-1 &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--priority &lt;span style=&#34;color: #ae81ff&#34;&gt;1021&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--destination-port-range &lt;span style=&#34;color: #ae81ff&#34;&gt;500&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--protocol Udp
az network nsg rule create --resource-group &lt;span style=&#34;color: #f8f8f2&#34;&gt;$RG_NAME&lt;/span&gt; --nsg-name &lt;span style=&#34;color: #f8f8f2&#34;&gt;$NSG_NAME&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--name allow-l2tp-ipsec-2 &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--priority &lt;span style=&#34;color: #ae81ff&#34;&gt;1022&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--destination-port-range &lt;span style=&#34;color: #ae81ff&#34;&gt;1701&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--protocol Udp
az network nsg rule create --resource-group &lt;span style=&#34;color: #f8f8f2&#34;&gt;$RG_NAME&lt;/span&gt; --nsg-name &lt;span style=&#34;color: #f8f8f2&#34;&gt;$NSG_NAME&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--name allow-l2tp-ipsec-3 &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--priority &lt;span style=&#34;color: #ae81ff&#34;&gt;1023&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--destination-port-range &lt;span style=&#34;color: #ae81ff&#34;&gt;4500&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--protocol Udp

&lt;span style=&#34;color: #75715e&#34;&gt;# OpenVPN&lt;/span&gt;
&lt;span style=&#34;color: #75715e&#34;&gt;# (not adding DNS rule)&lt;/span&gt;
az network nsg rule create --resource-group &lt;span style=&#34;color: #f8f8f2&#34;&gt;$RG_NAME&lt;/span&gt; --nsg-name &lt;span style=&#34;color: #f8f8f2&#34;&gt;$NSG_NAME&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--name allow-openvpn-1 &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--priority &lt;span style=&#34;color: #ae81ff&#34;&gt;1031&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--destination-port-range &lt;span style=&#34;color: #ae81ff&#34;&gt;636&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--protocol Tcp
az network nsg rule create --resource-group &lt;span style=&#34;color: #f8f8f2&#34;&gt;$RG_NAME&lt;/span&gt; --nsg-name &lt;span style=&#34;color: #f8f8f2&#34;&gt;$NSG_NAME&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--name allow-openvpn-2 &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--priority &lt;span style=&#34;color: #ae81ff&#34;&gt;1032&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--destination-port-range &lt;span style=&#34;color: #ae81ff&#34;&gt;8757&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--protocol Udp

&lt;span style=&#34;color: #75715e&#34;&gt;# OpenConnect / Cisco AnyConnect&lt;/span&gt;
az network nsg rule create --resource-group &lt;span style=&#34;color: #f8f8f2&#34;&gt;$RG_NAME&lt;/span&gt; --nsg-name &lt;span style=&#34;color: #f8f8f2&#34;&gt;$NSG_NAME&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--name allow-openconnect &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--priority &lt;span style=&#34;color: #ae81ff&#34;&gt;1040&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--destination-port-range &lt;span style=&#34;color: #ae81ff&#34;&gt;4443&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--protocol &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;#39;*&amp;#39;&lt;/span&gt;

&lt;span style=&#34;color: #75715e&#34;&gt;# Shadowsocks&lt;/span&gt;
az network nsg rule create --resource-group &lt;span style=&#34;color: #f8f8f2&#34;&gt;$RG_NAME&lt;/span&gt; --nsg-name &lt;span style=&#34;color: #f8f8f2&#34;&gt;$NSG_NAME&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--name allow-shadowsocks &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--priority &lt;span style=&#34;color: #ae81ff&#34;&gt;1050&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--destination-port-range &lt;span style=&#34;color: #ae81ff&#34;&gt;8530&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--protocol Tcp

&lt;span style=&#34;color: #75715e&#34;&gt;# Stunnel&lt;/span&gt;
az network nsg rule create --resource-group &lt;span style=&#34;color: #f8f8f2&#34;&gt;$RG_NAME&lt;/span&gt; --nsg-name &lt;span style=&#34;color: #f8f8f2&#34;&gt;$NSG_NAME&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--name allow-stunnel &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--priority &lt;span style=&#34;color: #ae81ff&#34;&gt;1060&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--destination-port-range &lt;span style=&#34;color: #ae81ff&#34;&gt;993&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--protocol Tcp

&lt;span style=&#34;color: #75715e&#34;&gt;# Tor&lt;/span&gt;
az network nsg rule create --resource-group &lt;span style=&#34;color: #f8f8f2&#34;&gt;$RG_NAME&lt;/span&gt; --nsg-name &lt;span style=&#34;color: #f8f8f2&#34;&gt;$NSG_NAME&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--name allow-tor-1-bridge &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--priority &lt;span style=&#34;color: #ae81ff&#34;&gt;1071&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--destination-port-range &lt;span style=&#34;color: #ae81ff&#34;&gt;8443&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--protocol Tcp
az network nsg rule create --resource-group &lt;span style=&#34;color: #f8f8f2&#34;&gt;$RG_NAME&lt;/span&gt; --nsg-name &lt;span style=&#34;color: #f8f8f2&#34;&gt;$NSG_NAME&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--name allow-tor-2-obsf4 &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--priority &lt;span style=&#34;color: #ae81ff&#34;&gt;1072&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--destination-port-range &lt;span style=&#34;color: #ae81ff&#34;&gt;9443&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--protocol Tcp

&lt;span style=&#34;color: #75715e&#34;&gt;# WireGuard&lt;/span&gt;
&lt;span style=&#34;color: #75715e&#34;&gt;# (not adding DNS rule)&lt;/span&gt;
az network nsg rule create --resource-group &lt;span style=&#34;color: #f8f8f2&#34;&gt;$RG_NAME&lt;/span&gt; --nsg-name &lt;span style=&#34;color: #f8f8f2&#34;&gt;$NSG_NAME&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--name allow-wireguard &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--priority &lt;span style=&#34;color: #ae81ff&#34;&gt;1080&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--destination-port-range &lt;span style=&#34;color: #ae81ff&#34;&gt;51820&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
	--protocol Udp
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;You can find all the code from this post in &lt;a href=&#34;https://gist.github.com/czers/22b7aa45a0a256c1d93b63bb3c36ec22&#34;&gt;this Gist&lt;/a&gt;. If you have any
comments, &lt;a href=&#34;http://czers.pl/about/&#34;&gt;About page&lt;/a&gt; has some info on how to reach me.&lt;/p&gt;

&lt;p&gt;If you like this post, &lt;a href=&#34;http://czers.pl/about/#postcard&#34;&gt;send me a postcard!&lt;/a&gt;&lt;/p&gt;</description>
    </item>
    
  </channel>
</rss>